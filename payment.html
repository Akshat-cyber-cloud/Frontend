<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - TicketBooking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Navbar (same as other pages) -->
    <nav class="bg-white shadow-lg fixed w-full z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="index.html" class="flex items-center">
                        <span class="text-2xl font-bold text-blue-600">TicketBooking</span>
                    </a>
                </div>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="index.html" class="nav-link text-gray-600 hover:text-blue-600 font-medium">Home</a>
                    <a href="movies.html" class="nav-link text-gray-600 hover:text-blue-600 font-medium">Movies</a>
                    <a href="sports.html" class="nav-link text-gray-600 hover:text-blue-600 font-medium">Sports</a>
                    <a href="concerts.html" class="nav-link text-gray-600 hover:text-blue-600 font-medium">Concerts</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 pt-24 pb-12">
        <div class="max-w-2xl mx-auto">
            <!-- Order Summary -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Order Summary</h2>
                <div id="orderSummary" class="space-y-4">
                    <p class="text-gray-600">Loading booking details...</p>
                </div>
            </div>
            
            <!-- Payment Form -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Payment Details</h2>
                <form id="paymentForm" class="space-y-6">
                    <!-- Payment Method Selection -->
                    <div>
                        <label class="text-gray-700 font-medium mb-2 block">Payment Method</label>
                        <div class="grid grid-cols-3 gap-4">
                            <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:border-blue-500 transition">
                                <input type="radio" name="paymentMethod" value="creditCard" class="mr-2" checked>
                                <span><i class="far fa-credit-card mr-2"></i>Credit Card</span>
                            </label>
                            <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:border-blue-500 transition">
                                <input type="radio" name="paymentMethod" value="debitCard" class="mr-2">
                                <span><i class="fas fa-credit-card mr-2"></i>Debit Card</span>
                            </label>
                            <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:border-blue-500 transition">
                                <input type="radio" name="paymentMethod" value="upi" class="mr-2">
                                <span><i class="fas fa-mobile-alt mr-2"></i>UPI</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Credit Card Details (shown by default) -->
                    <div id="creditCardDetails" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="cardName" class="block text-sm font-medium text-gray-700">Name on Card</label>
                                <input type="text" id="cardName" name="cardName" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="cardNumber" class="block text-sm font-medium text-gray-700">Card Number</label>
                                <input type="text" id="cardNumber" name="cardNumber" 
                                    placeholder="XXXX XXXX XXXX XXXX" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="col-span-1">
                                <label for="expiryMonth" class="block text-sm font-medium text-gray-700">Expiry Month</label>
                                <select id="expiryMonth" name="expiryMonth" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="">MM</option>
                                    <option value="01">01</option>
                                    <option value="02">02</option>
                                    <option value="03">03</option>
                                    <option value="04">04</option>
                                    <option value="05">05</option>
                                    <option value="06">06</option>
                                    <option value="07">07</option>
                                    <option value="08">08</option>
                                    <option value="09">09</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                </select>
                            </div>
                            <div class="col-span-1">
                                <label for="expiryYear" class="block text-sm font-medium text-gray-700">Expiry Year</label>
                                <select id="expiryYear" name="expiryYear" required
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="">YYYY</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                </select>
                            </div>
                            <div>
                                <label for="cvv" class="block text-sm font-medium text-gray-700">CVV</label>
                                <input type="text" id="cvv" name="cvv" placeholder="123" required maxlength="3"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- UPI Details (hidden by default) -->
                    <div id="upiDetails" class="space-y-4 hidden">
                        <div>
                            <label for="upiId" class="block text-sm font-medium text-gray-700">UPI ID</label>
                            <input type="text" id="upiId" name="upiId" placeholder="yourname@upi"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <!-- Payment Button -->
                    <button type="submit"
                        class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center justify-center">
                        <span class="mr-2">Pay Now</span>
                        <span id="paymentAmount">₹0</span>
                    </button>
                </form>
            </div>
        </div>
    </main>

    <script>
        // Get booking ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const bookingId = urlParams.get('bookingId');

        // Function to fetch booking details
        async function fetchBookingDetails() {
            try {
                const response = await fetch(`../backend/get_booking.php?id=${bookingId}`);
                const data = await response.json();
                
                if (data.success && data.booking) {
                    const booking = data.booking;
                    document.getElementById('orderSummary').innerHTML = `
                        <div class="border-b pb-4">
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-700">Booking ID:</span>
                                <span class="font-semibold" data-field="booking-id">${booking.id}</span>
                            </div>
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-700">Event:</span>
                                <span class="font-semibold" data-field="event-name">${booking.event_name}</span>
                            </div>
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-700">Event Type:</span>
                                <span class="font-semibold" data-field="event-type">${booking.event_type}</span>
                            </div>
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-700">Date:</span>
                                <span class="font-semibold" data-field="event-date">${booking.event_date}</span>
                            </div>
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-700">Ticket Type:</span>
                                <span class="font-semibold" data-field="ticket-type">${booking.ticket_type}</span>
                            </div>
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-700">Quantity:</span>
                                <span class="font-semibold" data-field="quantity">${booking.quantity}</span>
                            </div>
                        </div>
                        <div class="pt-4">
                            <div class="flex justify-between text-lg font-bold">
                                <span>Total Amount:</span>
                                <span class="text-blue-600" data-field="total-amount">₹${booking.total_amount}</span>
                            </div>
                        </div>
                    `;

                    // Update payment amount
                    document.getElementById('paymentAmount').textContent = `₹${booking.total_amount}`;
                } else {
                    throw new Error(data.message || 'Failed to fetch booking details');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('orderSummary').innerHTML = `
                    <div class="text-red-600">
                        Error loading booking details: ${error.message}
                    </div>
                `;
            }
        }

        // Toggle payment method details
        const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
        paymentMethods.forEach(method => {
            method.addEventListener('change', function() {
                document.getElementById('creditCardDetails').classList.toggle('hidden', this.value === 'upi');
                document.getElementById('upiDetails').classList.toggle('hidden', this.value !== 'upi');
            });
        });

        // Handle form submission
        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonContent = submitButton.innerHTML;
            
            // Disable the button and show processing state
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="mr-2">Processing...</span><i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
                const paymentData = {
                    bookingId: bookingId,
                    paymentMethod: paymentMethod
                };

                if (paymentMethod === 'creditCard' || paymentMethod === 'debitCard') {
                    paymentData.cardDetails = {
                        name: document.getElementById('cardName').value,
                        number: document.getElementById('cardNumber').value,
                        expiryMonth: document.getElementById('expiryMonth').value,
                        expiryYear: document.getElementById('expiryYear').value,
                        cvv: document.getElementById('cvv').value
                    };
                } else if (paymentMethod === 'upi') {
                    paymentData.upiId = document.getElementById('upiId').value;
                }

                const response = await fetch('../backend/update_payment.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                });

                const result = await response.json();
                
                if (result.success) {
                    // Show success message
                    const successMessage = document.createElement('div');
                    successMessage.className = 'fixed top-0 left-0 w-full p-4 bg-green-500 text-white text-center';
                    successMessage.textContent = 'Payment successful! Your booking has been confirmed.';
                    document.body.appendChild(successMessage);
                    
                    // Get the user email from localStorage
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    const userEmail = userData.email;
                    
                    // Store booking info in localStorage with proper event details
                    const currentBookings = JSON.parse(localStorage.getItem('myBookings') || '[]');
                    
                    // Get booking details from the order summary
                    const orderSummary = document.getElementById('orderSummary');
                    const newBooking = {
                        id: bookingId,
                        event_name: orderSummary.querySelector('[data-field="event-name"]').textContent,
                        event_type: orderSummary.querySelector('[data-field="event-type"]').textContent.toLowerCase(),
                        event_date: orderSummary.querySelector('[data-field="event-date"]').textContent,
                        ticket_type: orderSummary.querySelector('[data-field="ticket-type"]').textContent,
                        quantity: parseInt(orderSummary.querySelector('[data-field="quantity"]').textContent),
                        total_amount: parseFloat(orderSummary.querySelector('[data-field="total-amount"]').textContent.replace('₹', '')),
                        status: 'confirmed',
                        payment_status: 'completed',
                        email: userEmail,
                        booking_date: new Date().toISOString()
                    };

                    // Remove any existing booking with the same ID
                    const existingIndex = currentBookings.findIndex(b => b.id === bookingId);
                    if (existingIndex !== -1) {
                        currentBookings.splice(existingIndex, 1);
                    }
                    
                    // Add the new booking
                    currentBookings.push(newBooking);
                    localStorage.setItem('myBookings', JSON.stringify(currentBookings));
                    
                    // Add a view bookings button and confirmation message
                    setTimeout(() => {
                        successMessage.remove();
                        const bookingConfirmed = document.createElement('div');
                        bookingConfirmed.className = 'mt-6 text-center';
                        bookingConfirmed.innerHTML = `
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                <i class="fas fa-check-circle text-green-500 text-2xl mb-2"></i>
                                <h3 class="text-lg font-semibold text-green-800">Booking Confirmed!</h3>
                                <p class="text-green-700 mb-2">Your payment has been processed successfully.</p>
                                <div class="text-left bg-white p-4 rounded-lg mb-4">
                                    <p class="text-gray-700"><strong>Event:</strong> ${newBooking.event_name}</p>
                                    <p class="text-gray-700"><strong>Date:</strong> ${newBooking.event_date}</p>
                                    <p class="text-gray-700"><strong>Tickets:</strong> ${newBooking.quantity} ${newBooking.ticket_type}</p>
                                    <p class="text-gray-700"><strong>Total Paid:</strong> ₹${newBooking.total_amount}</p>
                                </div>
                                <a href="my-bookings.html" class="inline-block bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition duration-300">
                                    View My Bookings
                                </a>
                            </div>
                        `;
                        document.querySelector('.max-w-2xl').appendChild(bookingConfirmed);
                        
                        // Disable the payment form
                        const form = document.getElementById('paymentForm');
                        const inputs = form.querySelectorAll('input, select, button');
                        inputs.forEach(input => input.disabled = true);
                        submitButton.innerHTML = 'Payment Completed';
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Payment failed');
                }
            } catch (error) {
                console.error('Payment error:', error);
                const errorMessage = document.createElement('div');
                errorMessage.className = 'fixed top-0 left-0 w-full p-4 bg-red-500 text-white text-center';
                errorMessage.textContent = error.message || 'Payment failed. Please try again.';
                document.body.appendChild(errorMessage);
                
                // Remove error message after 5 seconds
                setTimeout(() => {
                    errorMessage.remove();
                }, 5000);
                
                // Reset button state
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonContent;
            }
        });

        // Fetch booking details when the page loads
        if (bookingId) {
            fetchBookingDetails();
        } else {
            document.getElementById('orderSummary').innerHTML = `
                <div class="text-red-600">
                    No booking ID provided. Please start from the booking page.
                </div>
            `;
        }
    </script>
</body>
</html> 